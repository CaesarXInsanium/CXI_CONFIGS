var exam_id,student_id,session_id,exam_toggles,current_attempt;var came_from_launch=0;let translations;checkAccessCode();var first_question=jQuery("div.display_question").eq(0);var first_question_num=first_question.find("div.header > span.question_name").text().trim();var all_at_once=jQuery("div.display_question").length>1?true:false;var log_loaded=false;var disable_printing="1";var disable_new_tabs="0";var focus_window_count=0;var display_count_bypass=0;if(document.referrer.indexOf("/take?user_id")>0)came_from_launch=true;chrome.extension.onMessage.addListener((function(msg,sender,sendResponse){if("relaunch_webcam"===msg.action){relaunchWebCamera();chrome.runtime.sendMessage({message:"focus_page"})}else if("custom_msg"===msg.action)showCanvasMessage(msg.msg,msg.type,5);else if("webcam_error"===msg.action)webcamError();else if("webcam_restarted"===msg.action){if(parseInt(exam_toggles[12]["value"])&&!display_count_bypass)chrome.runtime.sendMessage({message:"display_count"});if(parseInt(exam_toggles[17]["value"]))chrome.runtime.sendMessage({message:"begin_fullscreen"})}else if("display_count"===msg.action&&parseInt(exam_toggles[12]["value"])&&!display_count_bypass)chrome.runtime.sendMessage({message:"display_count_pause_menu"});else if("focus_test"===msg.action)chrome.runtime.sendMessage({message:"focus_page"});else if("showcalculator"===msg.action||"showcalculatorsci"===msg.action){const calculatorType="showcalculator"===msg.action?"basic":"scientific";showCalculator(calculatorType)}else if("opencalculator"===msg.action||"opencalculatorsci"===msg.action)toggleCalculator(true);else if("hidecalculators"===msg.action)hideCalculators();else if("closecalculators"===msg.action)toggleCalculator(false,false);else if("open_support_chat"===msg.action){hlChat.destroy();hlChat.setGroupId(msg.group_id);hlChat.injectCode();hlChat.maximizeWindow()}else if("showwebcam"===msg.action)toggleWebcamVisibilty(true);else if("hidewebcam"===msg.action)toggleWebcamVisibilty(false);else if("compresswebcam"===msg.action)toggleWebcamCompressed(true);else if("expandwebcam"===msg.action)toggleWebcamCompressed(false)}));function displayProctoringStartedMessage(){if(came_from_launch&&"Question 1"==first_question_num)showCanvasMessage(translations.canvas_run.proctoring_started,"info",15)}function removeInstructions(){var iframe=document.getElementById("hlinstructframe");if(iframe)iframe.style.display="none";var iframe2=document.getElementById("honorframe");if(iframe2)iframe2.style.display="none";var instructions=document.getElementById("quiz-instructions");if(instructions)instructions.style.display="none";var show_btn=document.createElement("button");show_btn.setAttribute("class","Button");show_btn.innerHTML=translations.canvas_run.show_instructions;show_btn.style.marginBottom="10px";instructions.parentNode.insertBefore(show_btn,instructions);show_btn.addEventListener("click",(function(){if("none"==instructions.style.display){instructions.style.display="block";show_btn.innerHTML=translations.canvas_run.hide_instructions}else{instructions.style.display="none";show_btn.innerHTML=translations.canvas_run.show_instructions}}))}function formatLinks(){$.each($("a.instructure_file_link"),(function(i,link){try{var accepted_types=["pdf","xlsx","xls","docx","doc","csv"];var file_link=[];file_link.title=$(this).attr("title");file_link.type=file_link.title.split(".").pop();void 0;if(accepted_types.includes(file_link.type)){void 0;$(this).addClass("no-warning")}}catch(e){}}));var links=$(".display_question .text a, #quiz-instructions a");links.attr("target","_blank");links.attr("rel","noreferrer noopener");$(".question_text a").addClass("no-warning")}function checkAccessCode(){var access_code=document.getElementById("quiz_access_code");var redirect="";if(access_code){var url=window.location.href;var quiz_index=url.indexOf("/quizzes/");var quiz_end_index=url.indexOf("/",quiz_index+9);var redirect=url.substr(0,quiz_end_index);window.location=redirect}}function checkForRelaunch(){chrome.runtime.sendMessage({message:"check_webcam"})}function webcamError(){pauseAllTabs(translations.canvas_run.webcam_problem,true)}function relaunchWebCamera(){pauseAllTabs(translations.webcam.relaunch,true)}function pauseAllTabs(reason,relaunch=false){chrome.runtime.sendMessage({message:"pause_all_tabs",reason:[reason],relaunch:relaunch})}function resumeAllTabs(){setTimeout((function(){chrome.runtime.sendMessage({message:"resume_all_tabs"})}),750)}chrome.storage.local.get(null,(storage=>{if(!storage.exam_state||"submitted"==storage.exam_state)return;if("paused"==storage.exam_state)pauseAllTabs(storage.pause_reasons);display_count_bypass=storage.display_count_bypass||0;lms_student_email=storage.student_email||"";exam_id=storage.exam_id;student_id=storage.student_id;session_id=storage.session_id;exam_toggles=storage.exam_toggles;current_attempt=storage.canvas_attempt_id||document.getElementsByName("attempt")[0].value;translations=storage.translations;displayProctoringStartedMessage();var question_element=jQuery("div.display_question");var html_element=jQuery("html");if(!!parseInt(exam_toggles[2]["value"])){elements=[html_element];trackEvent(elements)}trackWindowClose();setupExamOptions();removeInstructions();formatLinks();insertRightSidebar();insertExamTools();listenForEvents();if("object"===typeof hlIdleBrowserCapture)hlIdleBrowserCapture.init({translations:translations});chrome.runtime.sendMessage({message:"inject_shortcut_detection",type:"browser_guard"});const hlChatParameters={lmsSchoolId:lms_school_id,examId:exam_id,studentId:student_id,lmsStudentName:lms_student_name,lmsStudentEmail:lms_student_email,license:livechat_license,withExamTools:true};hlChat.init(hlChatParameters);if(!storage.bypass_status){checkForRelaunch();setInterval((function(){chrome.runtime.sendMessage({message:"check_webcam"})}),3e4)}if(all_at_once)jQuery(".answers").find('input[type="radio"]').click((function(){let question_answered=jQuery(this).closest("div.display_question");postLog("Load",question_answered)}));postLog("Load",first_question)}));function setupExamOptions(){if(void 0==exam_toggles[28])exam_toggles[28]={id:28,value:"0"};if(!!parseInt(exam_toggles[2]["value"]))disableTinymceEvents();if(parseInt(exam_toggles[9]["value"]))disable_printing=exam_toggles[9]["value"];if(parseInt(exam_toggles[12]["value"])&&!display_count_bypass)chrome.runtime.sendMessage({message:"display_count"});if(parseInt(exam_toggles[17]["value"]))chrome.runtime.sendMessage({message:"begin_fullscreen"});if(parseInt(exam_toggles[12]["value"])&&!display_count_bypass)chrome.runtime.sendMessage({message:"display_count"});if("1"==disable_printing){var print_style=document.createElement("style");print_style.media="print";print_style.appendChild(document.createTextNode("body { visibility: hidden; display: none; }"));document.head.appendChild(print_style)}}function postLog(event_type,question){var question_text=question.find("div.question_text").text().trim();var question_html=question.find("div.question_text").html();var question_num=question.find("div.header > span.question_name").text().trim();let logData={event_type:event_type,question_num:question_num,question_text:question_text,question_html:question_html,school_identifier:lms_school_id,exam_identifier:lms_exam_id,student_identifier:lms_user_id,current_attempt:current_attempt,came_from_launch:came_from_launch,user_name:lms_student_name,lms_id:2,hl_student_id:student_id};chrome.runtime.sendMessage({message:"lms_log",data:logData})}function trackWindowClose(){let isLastElementLinkingQuestion=false;let isLastElementSubmittingExam=false;const anchorElements=document.querySelectorAll("a");anchorElements.forEach((anchor=>{anchor.addEventListener("click",(()=>{isLastElementLinkingQuestion=checkElementLinksToQuestion(anchor)}))}));const buttonElements=document.querySelectorAll("button");buttonElements.forEach((button=>{button.addEventListener("click",(()=>{isLastElementLinkingQuestion=checkElementLinksToQuestion(button);isLastElementSubmittingExam=checkElementSubmitsExam(button)}))}));function checkElementLinksToQuestion(domElement){const elementHref=domElement.href||"";const elementAction=domElement.dataset.action||"";return domElement&&!elementHref.endsWith("#")&&elementHref.indexOf("/take/questions")>-1||domElement.classList.contains("next-question")||domElement.classList.contains("previous-question")||elementAction.indexOf("next_question_path")>-1}function checkElementSubmitsExam(domElement){const elementAction=domElement.dataset.action||"";return domElement&&("submit_quiz_button"===domElement.id||domElement.classList.contains("submit_quiz_button")||elementAction.indexOf("submissions")>-1)}function handleBeforeUnloadEvent(){if(isLastElementLinkingQuestion)return;const countDownSeconds=document.querySelector("#times_up_dialog .countdown_seconds").innerText;if(isLastElementSubmittingExam||countDownSeconds){postLog("Exam Submit",first_question);chrome.storage.local.remove(["fullscreen_override"]);chrome.runtime.sendMessage({message:"disable_browser_guard"});chrome.runtime.sendMessage({message:"close_webcam",type:"submit"});return}postLog("Exam Browser Closed",first_question);chrome.runtime.sendMessage({message:"exam_window_closed"});chrome.runtime.sendMessage({message:"close_webcam",type:"relaunch"})}window.addEventListener("beforeunload",handleBeforeUnloadEvent);if(window.parent!==window)window.top.addEventListener("beforeunload",handleBeforeUnloadEvent)}function trackEvent(elements){if("undefined"!==typeof hlAlert)hlAlert.init();let eventsReadable={dragstart:translations.forbidden_events.dragstart,contextmenu:translations.forbidden_events.contextmenu,copy:translations.forbidden_events.copy,paste:translations.forbidden_events.paste,cut:translations.forbidden_events.cut};let eventsLogged={dragstart:"Drag and Drop",contextmenu:"Right Click",copy:"Copy",paste:"Paste",cut:"Cut"};elements.forEach((element=>{["contextmenu","dragstart","copy","paste","cut"].forEach((event=>{element.bind(event,(e=>{e.preventDefault();let capitalize=([firstLetter,...restOfWord])=>firstLetter.toUpperCase()+restOfWord.join("");let eventDisplayed=eventsReadable[event]?eventsReadable[event]:capitalize(event);hlAlert.showAlert("exam",eventDisplayed,null,{timeout:3e3});var question=jQuery(e.currentTarget).closest("div.display_question");postLog(eventsLogged[event],question)}))}))}))}function disableTinymceEvents(){if("undefined"!==typeof hlAlert)hlAlert.init();let eventsReadable={dragstart:translations.forbidden_events.dragstart,contextmenu:translations.forbidden_events.contextmenu,copy:translations.forbidden_events.copy,paste:translations.forbidden_events.paste,cut:translations.forbidden_events.cut};let eventsLogged={dragstart:"Drag and Drop",contextmenu:"Right Click",copy:"Copy",paste:"Paste",cut:"Cut"};document.addEventListener("tinyRCE/initExternalTools",(e=>{chrome.runtime.sendMessage({message:"append_script",filename:"js_web/disable_tinymce.js"})}));document.addEventListener("hl_tinymce_event",(function(e){const eventDisplayed=eventsReadable[e.detail.event_type];hlAlert.showAlert("exam",eventDisplayed,null,{timeout:3e3});const question=jQuery(e.currentTarget).closest("div.display_question");postLog(eventsLogged[e.detail.event_type],question)}))}function showCanvasMessage(message,alert,seconds,icon){if("undefined"===typeof message)return false;var defaults={alert:"info",icon:"icon-info",seconds:3};var alert=alert.match(/^(info|success|warning|error)$/)?alert:defaults.alert;var icon=icon||defaults.icon;var seconds=seconds||defaults.seconds;var divID=Math.floor(9e4*Math.random())+1e4;$("#flash_message_holder").css("z-index","9999999999999");$("#flash_message_holder").append(`\n        <li id="hl-message-`+divID+`" class="ic-flash-`+alert+`" aria-hidden="true" style="z-index: 2;">\n            <div class="ic-flash__icon"><i class="`+icon+`"></i></div>\n            `+message+`\n            <button type="button" class="Button Button--icon-action close_link">\n                <i class="icon-x"></i>\n            </button>\n        </li>`);setTimeout((function(){$("#hl-message-"+divID).remove()}),1e3*seconds)}function addSidebarItems(item){$.each(item,(function(key,value){if(!value["include"])return true;var sidebar_item=`\n            <li>\n                <span id="`+value["id"]+`">\n                    <a href="#">\n                        <i class="`+value["class"]+` hl-sidebar"></i>\n                        `+`<span class="hl-sidebar-text">`+value["title"]+`</span>\n                    </a>\n                </span>\n            </li>`;$("#sidebar_content > ul").append(sidebar_item)}))}function insertRightSidebar(forceAction){const includeCalculator="showCalculator"===forceAction?true:"hideCalculators"===forceAction?false:1===parseInt(exam_toggles[19]["value"])||1===parseInt(exam_toggles[28]["value"]);const sidebar={calculator:{id:"hl-sidebar-calculator-toggle",class:"icon-assignment",title:translations.calculator,include:includeCalculator},livechat:{id:"hl-livechat-link",class:"icon-discussion",title:translations.live_chat,include:true}};$("#sidebar_content").remove();$("#right-side").append(`\n        <div id="sidebar_content" class="rs-margin-bottom" style="margin-top: 20px;">\n            <h2 class="hl-sidebar-header">${translations.support_247}</h2>\n            <ul class="page-action-list" style="margin-top: 0px;"></ul>\n        </div>`);addSidebarItems(sidebar);$("#hl-sidebar-calculator-toggle").on("click touchstart",toggleCalculator);if(""!==forceAction)document.getElementById("hl-livechat-link").onclick=()=>{LiveChatWidget.call("maximize")};$("#right-side-wrapper, #right-side").fadeIn("slow")}function openCanvasGuide(){chrome.runtime.sendMessage({message:"open_canvas_guide",lms_current_url:document.referrer})}function showCalculator(calculatorType){insertRightSidebar("showCalculator");if("object"===typeof hlExamTools)hlExamTools.proctorAddCalculatorToExam(calculatorType)}function toggleCalculator(setActiveState=null,forceFocus=true){if("object"===typeof hlExamTools)hlExamTools.toggleCalculator(setActiveState,forceFocus)}function hideCalculators(){insertRightSidebar("hideCalculators");if("object"===typeof hlExamTools)hlExamTools.proctorRemoveCalculatorFromExam()}function adjustWebcamPositionForChat(isActive){if("object"===typeof hlExamTools)hlExamTools.adjustWebcamPositionForChat(isActive)}function toggleWebcamVisibilty(shouldBeVisible){if("object"===typeof hlExamTools)hlExamTools.toggleWebcam(shouldBeVisible)}function toggleWebcamCompressed(shouldBeCompressed){if("object"===typeof hlExamTools)hlExamTools.toggleWebcamCompressed(shouldBeCompressed)}function listenForEvents(){document.addEventListener("launchcam",(function(){chrome.runtime.sendMessage({message:"webcam_launch",url:hl_url+"/webapp/camera",session_id:session_id,lms_id:2,relaunch:0,current_url:window.location.hostname})}));document.addEventListener("highlightchat",(function(){chrome.runtime.sendMessage({message:"highlight_page"})}));document.addEventListener("focuschat",(function(){chrome.runtime.sendMessage({message:"focus_page"})}));document.addEventListener("cleanslate",(function(){chrome.storage.local.clear()}));document.addEventListener("opensesame",(function(){chrome.runtime.sendMessage({message:"bypass_payment"})}));document.addEventListener("nextstep",(function(){chrome.runtime.sendMessage({message:"livechat_command_nextstep"})}));document.addEventListener("cyclevideo",(function(){chrome.runtime.sendMessage({message:"cyclevideo"})}));document.addEventListener("allowsite",(function(e){chrome.runtime.sendMessage({message:"add_whitelist_url",url:e.detail})}));document.addEventListener("relaunchcam",(function(){chrome.runtime.sendMessage({message:"webcam_launch",url:hl_url+"/webapp/camera",session_id:session_id,lms_id:2,relaunch:1,current_url:window.location.hostname})}));document.addEventListener("hiderelaunch",(function(){try{$("[aria-label='honorframe']").each((function(i,obj){$(this).remove()}));$(".modal-overlay").each((function(i,obj){$(this).hide()}))}catch(e){void 0}chrome.runtime.sendMessage({message:"resume_all_tabs"})}));document.addEventListener("exitfullscreen",(function(){chrome.runtime.sendMessage({message:"exit_fullscreen"});chrome.storage.local.set({fullscreen_override:1})}));document.addEventListener("enableguard",(function(){chrome.storage.local.set({guardModeStatus:1});chrome.runtime.sendMessage({message:"enable_browser_guard"});chrome.runtime.sendMessage({message:"disable_new_tabs"});chrome.runtime.sendMessage({message:"begin_fullscreen"});chrome.runtime.sendMessage({message:"to_camera",msg:"enable_guard_camera"})}));document.addEventListener("disableguard",(function(){chrome.runtime.sendMessage({message:"disable_browser_guard"})}));document.addEventListener("showcalculator",(()=>showCalculator("basic")));document.addEventListener("showcalculatorsci",(()=>showCalculator("scientific")));document.addEventListener("hidecalculators",hideCalculators);document.addEventListener("opencalculator",(()=>toggleCalculator(true)));document.addEventListener("opencalculatorsci",(()=>toggleCalculator(true)));document.addEventListener("closecalculators",(()=>toggleCalculator(false,false)));document.addEventListener("chat-started",(()=>adjustWebcamPositionForChat(true)));document.addEventListener("chat-ended",(()=>adjustWebcamPositionForChat(false)));document.addEventListener("showwebcam",(()=>toggleWebcamVisibilty(true)));document.addEventListener("hidewebcam",(()=>toggleWebcamVisibilty(false)));document.addEventListener("compresswebcam",(()=>toggleWebcamCompressed(true)));document.addEventListener("expandwebcam",(()=>toggleWebcamCompressed(false)))}function insertExamTools(){if("object"===typeof hlExamTools){const isExamUsingWebcam=1===parseInt(exam_toggles[1]["value"]);hlExamTools.init({environmentUrl:hl_url,activeLms:"canvas",isExamUsingWebcam:isExamUsingWebcam,translations:translations})}}