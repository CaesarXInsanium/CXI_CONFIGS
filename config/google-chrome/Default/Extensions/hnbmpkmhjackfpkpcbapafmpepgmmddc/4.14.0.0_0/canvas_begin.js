var exam_id,student_id,session_id,exam_toggles,school_code,user_agent,exam_name,init_response;var bypass_status=0;var display_count=0;let translations;chrome.extension.onMessage.addListener((function(msg,sender,sendResponse){if("test_ready"==msg.action){submitAccessCode(msg.data);if(exam_toggles&&parseInt(exam_toggles[17].value))chrome.runtime.sendMessage({message:"begin_fullscreen"})}if("webcam_open"==msg.action)webcamOpenMessage();if("display_count"==msg.action)display_count=msg.data;if("webcam_closed_begin"==msg.action)if(exam_toggles&&parseInt(exam_toggles[14].value))chrome.runtime.sendMessage({message:"disable_browser_guard"});if("checklist_complete"==msg.action){var data={lms_id:2,exam_id:exam_id,student_id:student_id,session_id:session_id,exam_name:exam_name,school_code:school_code};sendResponse(data)}if("focus_test"===msg.action)chrome.runtime.sendMessage({message:"focus_page"});if("send_chat"===msg.action)sendLivechatMsg(msg.message);if("open_support_chat"===msg.action){hlChat.destroy();hlChat.setGroupId(msg.group_id);hlChat.injectCode();hlChat.maximizeWindow()}if("display_count_bypass"==msg.action)chrome.storage.local.set({display_count_bypass:1});if("show_exam_webcam"===msg.action)insertExamTools()}));studentInit();function hideAccessCode(){$("form.access_code_form").hide();if($("#hl-loader").length)$("#hl-loader").remove()}function showAccessCode(){$("form.access_code_form").show();$('#content p:contains("This quiz is restricted")').show();if($("#hl-loader").length)$("#hl-loader").remove()}function insertRightSidebar(){var sidebar={livechat:{id:"hl-livechat-link",class:"icon-discussion",title:translations.live_chat,include:true},guide:{id:"hl-guide",class:"icon-pdf",title:translations.guide,include:true},accessibility:{id:"hl-accessibility",class:"icon-unlock",title:translations.accessibility,include:true}};$("#sidebar_content").remove();$("#right-side").append(`\n        <div id="sidebar_content" class="rs-margin-bottom">\n            <h2 class="hl-sidebar-header">${translations.proctoring_support}</h2>\n            <ul class="page-action-list" style="margin-top: 0px;"></ul>\n        </div>`);addSidebarItems(sidebar);accessibilityPINListener();$("#hl-accessibility").click((function(){toggleAccessibilityInput()}));$("#hl-guide").click((function(){openCanvasGuide()}));$("#right-side-wrapper, #right-side").fadeIn("slow")}function chat_commands_listeners(){document.addEventListener("launchcam",(function(){if(student_id)launchWebCamera()}));document.addEventListener("opensesame",(function(){chrome.runtime.sendMessage({message:"bypass_payment"})}));document.addEventListener("nextstep",(function(){chrome.runtime.sendMessage({message:"livechat_command_nextstep"})}));document.addEventListener("cyclevideo",(function(){chrome.runtime.sendMessage({message:"cyclevideo"})}));document.addEventListener("enableguard",(function(){chrome.storage.local.set({guardModeStatus:1});chrome.runtime.sendMessage({message:"enable_browser_guard"});chrome.runtime.sendMessage({message:"disable_new_tabs"});chrome.runtime.sendMessage({message:"begin_fullscreen"})}));document.addEventListener("disableguard",(function(){chrome.runtime.sendMessage({message:"disable_browser_guard"})}));document.addEventListener("cleanslate",(()=>chrome.storage.local.clear()));document.addEventListener("chat-started",(()=>adjustWebcamPositionForChat(true)));document.addEventListener("chat-ended",(()=>adjustWebcamPositionForChat(false)))}function addSidebarItems(item){$.each(item,(function(key,value){if(!value["include"])return true;var sidebar_item=`\n\t\t\t<li>\n\t\t\t\t<span id="`+value["id"]+`">\n\t\t\t\t\t<a href="#">\n\t\t\t\t\t\t<i class="`+value["class"]+` hl-sidebar"></i>\n                        `+value["title"]+`\n\t\t\t\t\t</a>\n\t\t\t\t</span>\n\t\t\t</li>`;$("#sidebar_content > ul").append(sidebar_item)}));$("#sidebar_content > ul").append(`\n        <li>\n            <div class="hl-accessibility" style="display: none;">\n                <label for="hl-pin" style="padding: 8px 10px 5px">${translations.accessibility_code_label}</label>\n                <input aria-label="${translations.accessibility_code_al}" type="password" id="hl-pin-input" maxlength="5">\n            </div>\n        </li>`)}function toggleAccessibilityInput(){$(".hl-accessibility").slideToggle()}function openCanvasGuide(){chrome.runtime.sendMessage({message:"open_canvas_guide",lms_current_url:document.referrer})}function accessibilityPINListener(){$("#hl-pin-input").keyup((async function(){var pin_color="black";var pin_value=$(this).val();if(5==pin_value.length){const usat=await getUsat().finally((usat=>usat));jQuery.ajax({url:hl_url+"/lms/bypasspincheck",beforeSend:function(xhr){xhr.setRequestHeader("Authorization","Bearer "+usat)},data:{pin:pin_value,student_id:student_id,lms_student_id:lms_student_id,lms_student_name:lms_student_name,ext_version:chrome.runtime.getManifest().version},type:"POST",async:false,success:function(response){if("1"==response)chrome.storage.local.set({bypass_status:1},(()=>{pin_color="green";bypass_status=1;requestAccessCode(0);chrome.runtime.sendMessage({message:"close_all_webcam_windows"})}));else if("2"==response)pin_color="orange";else pin_color="red"}}).fail((function(jQueryXHR,exception){pin_color="grey"}))}$("#hl-pin-input").css("color",pin_color)}))}function insertQuizBeginUI(){const outerContent=document.querySelector("#content > div");const outerContentWidth=outerContent.style.width;outerContent.style.width="100%";outerContent.style.maxWidth=outerContentWidth;const outerContentHeading=outerContent.querySelector("h2");const hlBegin=document.createElement("div");hlBegin.id="hl-begin";hlBegin.classList.add("hl-begin");hlBegin.style.display="none";hlBegin.appendChild(outerContentHeading);outerContent.prepend(hlBegin);$("#hl-begin").append(init_response.launch_screen).fadeIn("slow");hlUserAgreement.init(launchWebCamera);hlUserAgreement.setTranslations(translations);insertRightSidebar();const hlChatParameters={lmsSchoolId:lms_school_id,examId:init_response.exam_id,studentId:init_response.student_id,lmsStudentName:lms_student_name,lmsStudentEmail:lms_student_email,license:livechat_license,withExamTools:true};hlChat.init(hlChatParameters);chat_commands_listeners()}function sendLivechatMsg(msg){$("head").append(`\n        <script>\n            LiveChatWidget.call('maximize')\n        <\/script>\n    `)}function requestAccessCode(bypass_set=1){var data={lms_id:2,exam_id:exam_id,session_id:session_id,exam_name:exam_name,school_code:school_code};chrome.runtime.sendMessage({message:"access_request",data:data,bypass_set:bypass_set})}function resumeAllTabs(){chrome.runtime.sendMessage({message:"resume_all_tabs"})}function submitAccessCode(exam_access_code){if(1==bypass_status)createCookie("allow_relaunch_prompt","0",7);exam_access_code=exam_access_code.substring(0,exam_access_code.length-2);$("#quiz_access_code").val(exam_access_code).prop("type","hidden");$("form.access_code_form").trigger("submit")}function launchWebCamera(){if(1==bypass_status)requestAccessCode();else chrome.runtime.sendMessage({message:"webcam_launch",url:hl_url+"/webapp/camera",session_id:session_id,lms_id:2,relaunch:0,display_count:display_count,current_url:window.location.hostname})}async function webcamOpenMessage(){$(".hl-begin-header").html(translations.authentication.begin_header);$("#hl-begin-instructions").html(translations.canvas_begin.begin_instructions);$("#relaunch-proctoring").click((function(){$(this).css("color","#540baf");launchWebCamera()}));$("#relaunch-proctoring").on("keyup",(function(event){if(13==event.which)$(this).trigger("click")}))}function studentInit(){var billable=0;if(lms_user_roles.indexOf("student")>=0)billable=1;if(jQuery("#masquerade_bar").length>0)billable=0;var data={lms_id:2,lms_school_id:lms_school_id,lms_exam_id:lms_exam_id,lms_student_id:lms_student_id,lms_student_email:lms_student_email,lms_student_name:lms_student_name,href:window.location.href,user_agent:navigator.userAgent,billable:billable,ext_version:chrome.runtime.getManifest().version,browser_version:getChromeVersion()};chrome.runtime.sendMessage({message:"lms_init",data:data},(function(r){if(r.result){var response=r.response;init_response=response;if(1==response.status){exam_id=response.exam_id;student_id=response.student_id;session_id=response.session_id;exam_name=response.exam_name;bypass_status=response.bypass_status;school_code=response.school_code;user_agent=response.user_agent;exam_toggles=response.exam_toggles;translations=response.translations;var css=chrome.extension.getURL("assets/canvas.css");$('<link rel="stylesheet" type="text/css" href="'+css+'" >').appendTo("head");checkForHLframe();chrome.runtime.sendMessage({message:"exam_tab_id"},(function(){if(exam_toggles&&parseInt(exam_toggles[12]["value"]))chrome.runtime.sendMessage({message:"display_count"});if(1===bypass_status)requestAccessCode();else{hideAccessCode();insertQuizBeginUI()}chrome.storage.local.set({canvas_attempt_id:response.student_attempt})}))}else showAccessCode()}else{student_id="";session_id="";showAccessCode()}}))}$(window).keydown((function(e){if((e.metaKey||e.ctrlKey)&&e.shiftKey&&85==e.keyCode)showCanvasMessage("<strong>Honorlock StudentInit Response: </strong>"+init_response.message,"info",120);if((e.metaKey||e.ctrlKey)&&73==e.keyCode)void 0}));function studentInitDebugLog(obj){var result="";var toggles="";$.each(obj,(function(key,value){switch(key){case"exam_access_code":case"exam_toggles":$.each($(this)[0],(function(key,value){toggles+=value["code"]+": "+value["value"]+" | "}));return;default:break}result+=key+": "+value+"\n"}));return toggles+result}function getChromeVersion(){var raw=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);return raw?parseInt(raw[2],10):false}function checkForHLframe(){var iframe=document.getElementById("hlinstructframe");if(iframe){iframe.style.display="none";chrome.runtime.sendMessage({message:"close_webcam"});showCanvasMessage(translations.canvas_begin.internet_disconnect,"error",60);throw new Error("Stop")}}function createCookie(name,value,days){var expires="";if(days){var date=new Date;date.setTime(date.getTime()+24*days*60*60*1e3);expires="; expires="+date.toUTCString()}document.cookie=name+"="+value+expires+"; path=/"}function readCookie(name){var nameEQ=name+"=";var ca=document.cookie.split(";");for(var i=0;i<ca.length;i++){var c=ca[i];while(" "==c.charAt(0))c=c.substring(1,c.length);if(0==c.indexOf(nameEQ))return c.substring(nameEQ.length,c.length)}return null}function eraseCookie(name){createCookie(name,"",-1)}function showCanvasMessage(message,alert,seconds,icon){if("undefined"===typeof message)return false;var defaults={alert:"info",icon:"icon-info",seconds:3};var alert=alert.match(/^(info|success|warning|error)$/)?alert:defaults.alert;var icon=icon||defaults.icon;var seconds=seconds||defaults.seconds;var divID=Math.floor(9e4*Math.random())+1e4;$("#flash_message_holder").append(`\n        <li id="hl-message-`+divID+`" class="ic-flash-`+alert+`" aria-hidden="true" style="z-index: 2;">\n            <div class="ic-flash__icon"><i class="`+icon+`"></i></div>`+message+`\n            <button type="button" class="Button Button--icon-action close_link">\n                <i class="icon-x"></i>\n            </button>\n        </li>`);setTimeout((function(){$("#hl-message-"+divID).remove()}),1e3*seconds)}function insertExamTools(){if("object"===typeof hlExamTools){const isExamUsingWebcam=1===parseInt(exam_toggles[1]["value"]);hlExamTools.init({environmentUrl:hl_url,activeLms:"canvas",isExamBegin:true,isExamUsingWebcam:isExamUsingWebcam,translations:translations})}}function adjustWebcamPositionForChat(isActive){if("object"===typeof hlExamTools)hlExamTools.adjustWebcamPositionForChat(isActive)}